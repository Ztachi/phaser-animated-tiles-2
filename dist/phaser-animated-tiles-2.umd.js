(function(u,o){typeof exports=="object"&&typeof module<"u"?module.exports=o(require("phaser")):typeof define=="function"&&define.amd?define(["phaser"],o):(u=typeof globalThis<"u"?globalThis:u||self,u.AnimatedTiles=o(u.Phaser))})(this,function(u){"use strict";var L=Object.defineProperty;var g=(u,o,T)=>o in u?L(u,o,{enumerable:!0,configurable:!0,writable:!0,value:T}):u[o]=T;var p=(u,o,T)=>g(u,typeof o!="symbol"?o+"":o,T);class o extends u.Plugins.ScenePlugin{constructor(e,i){super(e,i,"AnimatedTiles");p(this,"map");p(this,"animatedTiles");p(this,"rate");p(this,"active");p(this,"activeLayer");p(this,"followTimeScale");p(this,"_loggedOnce");this.map=null,this.animatedTiles=[],this.rate=1,this.active=!1,this.activeLayer=[],this.followTimeScale=!0,this._loggedOnce=!1,e.sys.settings.isBooted||e.sys.events.once("boot",this.boot,this)}boot(){const e=this.systems.events;e.on("postupdate",this.postUpdate,this),e.on("shutdown",this.shutdown,this),e.on("destroy",this.destroy,this)}init(e){const i=this.getAnimatedTiles(e),s={map:e,animatedTiles:i,active:!0,rate:1,activeLayer:[]};e.layers.forEach(()=>s.activeLayer.push(!0)),this.animatedTiles.push(s),this.animatedTiles.length===1&&(this.active=!0),i.forEach(a=>{const l=a.frames[0].tileid;a.tiles.forEach((t,n)=>{var r;t.forEach(h=>{h&&h.index!==l&&(h.index=l)});const f=(r=e.layers[n])==null?void 0:r.tilemapLayer;f&&(f.dirty=!0)})})}setRate(e,i=null,s=null){if(i===null)s===null?this.rate=e:this.animatedTiles[s].rate=e;else{const a=l=>{l.forEach(t=>{t.index===i&&(t.rate=e)})};s===null?this.animatedTiles.forEach(l=>{a(l.animatedTiles)}):a(this.animatedTiles[s].animatedTiles)}}resetRates(e=null){e===null?(this.rate=1,this.animatedTiles.forEach(i=>{i.rate=1,i.animatedTiles.forEach(s=>{s.rate=1})})):this.animatedTiles[e]&&(this.animatedTiles[e].rate=1,this.animatedTiles[e].animatedTiles.forEach(i=>{i.rate=1}))}resume(e=null,i=null){const s=i===null?this:this.animatedTiles[i];e===null?s.active=!0:(s.activeLayer[e]=!0,"animatedTiles"in s&&s.animatedTiles.forEach(a=>{this.updateLayer(a,a.tiles[e])}))}pause(e=null,i=null){const s=i===null?this:this.animatedTiles[i];e===null?s.active=!1:s.activeLayer[e]=!1}postUpdate(e,i){if(!this.active)return;this._loggedOnce||(this._loggedOnce=!0);const s=i*this.rate*(this.followTimeScale&&this.scene?this.scene.time.timeScale:1);this.animatedTiles.forEach(a=>{if(!a.active)return;const l=s*a.rate;a.animatedTiles.forEach(t=>{if(t.next-=l*t.rate,t.next<0){const n=t.currentFrame,f=t.frames[n].tileid;let r=n+1;r>t.frames.length-1&&(r=0),t.next=t.frames[r].duration,t.currentFrame=r;const h=t.frames[r].tileid;t.tiles.forEach((y,E)=>{var m;if(!a.activeLayer[E])return;let d=0;if(y.forEach(c=>{c&&c.index===f&&(c.index=h,d++)}),d>0){const c=(m=a.map.layers[E])==null?void 0:m.tilemapLayer;c&&(c.dirty=!0)}})}})})}updateLayer(e,i,s=-1){const a=[],l=e.frames[e.currentFrame].tileid;i.forEach(t=>{s>-1&&(t===null||t.index!==s)?a.push(t):t.index=l}),a.forEach(t=>{const n=i.indexOf(t);n>-1&&i.splice(n,1)})}shutdown(){}destroy(){this.shutdown(),this.scene=void 0}getAnimatedTiles(e){const i=[];return e.tilesets.forEach(s=>{const a=s.tileData;if(!a)return;let l=[];Array.isArray(a)?l=a.map(t=>({index:t.id,data:t})):l=Object.keys(a).map(t=>({index:parseInt(t),data:a[t]})),l.forEach(({index:t,data:n})=>{if(n&&n.animation&&n.animation.length>0){const f={index:t+s.firstgid,frames:[],currentFrame:0,tiles:[],rate:1,next:0};n.animation.forEach(r=>{const h={duration:r.duration,tileid:r.tileid+s.firstgid};f.frames.push(h)}),f.next=f.frames[0].duration,e.layers.forEach((r,h)=>{const y=r.tilemapLayer;if(y&&(y.type==="StaticTilemapLayer"||y.constructor.name==="StaticTilemapLayer")){f.tiles.push([]);return}const d=[];r.data&&r.data.length>0&&r.data.forEach(m=>{m&&Array.isArray(m)&&m.forEach(c=>{c&&c.index!==-1&&c.index===t+s.firstgid&&d.push(c)})}),f.tiles.push(d)}),i.push(f)}})}),e.layers.forEach((s,a)=>{this.activeLayer[a]=!0}),i}updateAnimatedTiles(){let e=null;e===null&&(e=[],this.animatedTiles.forEach(i=>{e.push(i)})),e.forEach(i=>{i.animatedTiles.forEach(n=>{n.tiles.forEach((f,r)=>{const h=i.map.layers[r],y=h.tilemapLayer;if(!(y&&(y.type==="StaticTilemapLayer"||y.constructor.name==="StaticTilemapLayer"))&&!(!h.data||!Array.isArray(h.data))){for(let d=0;d<10;d++)if(h.data[d])for(let m=0;m<10;m++){if(!h.data[d][m])continue;const c=h.data[d][m];c.index==n.index&&(f.indexOf(c)===-1&&f.push(c),c.index=n.frames[n.currentFrame].tileid)}}})})})}static register(e){e.register("AnimatedTiles",o,"animatedTiles")}}return o});
